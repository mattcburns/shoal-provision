# Maintenance OS Build Artifacts

This directory contains the assets required to build the Shoal maintenance OS bootc image and accompanying ISO.

- `Containerfile` – multi-stage build that compiles the dispatcher binary and embeds systemd units, Quadlet definitions, and wrapper scripts into a bootc base image.
- `scripts/build_maintenance_os.sh` (at repository root) – helper that builds the container image with Podman and invokes `bootc-image-builder` to produce a bootable ISO.

## Prerequisites

- Linux host with `podman` and the ability to run privileged containers.
- Access to `quay.io/centos-bootc/bootc-image-builder:latest` (pulls automatically if absent).
- Sufficient disk space to store the intermediate container layers and ISO output (several GB).

## Quick Start

```bash
# Default (artifacts in build/maintenance-os)
./scripts/build_maintenance_os.sh

# Custom output directory and rootfs type
./scripts/build_maintenance_os.sh --output /tmp/shoal-maint-os --rootfs ext4
```

The script builds `shoal-maintenance:dev` from the repository root and runs `bootc-image-builder` to emit an ISO under the specified output directory. Use `IMAGE_NAME` or the `--image-name` flag to override the tag if you want to push to a registry. If `podman` is running in rootless mode, the script will export the image and re-run the builder under `sudo` (rootful) automatically.

## Customising the Build

- Override packages by editing the `dnf install` line in the `Containerfile`.
- Drop-in additional Quadlet units or systemd services under `internal/provisioner/maintenance/` before invoking the script.
- Provide a target architecture via `--arch aarch64` when building on a different platform.

## Supported Workflows

The maintenance OS supports provisioning multiple operating systems:

### Linux Provisioning
- Partition creation and formatting (ext4, xfs, vfat, swap)
- Rootfs extraction from OCI tarball via `oras` (from embedded registry or external sources)
- GRUB bootloader installation via chroot
- Cloud-init Config Drive (NoCloud)

**OCI Registry Integration:**
The maintenance OS pulls rootfs artifacts from the Shoal embedded registry:
```bash
oras pull controller:8080/os-images/ubuntu-rootfs:22.04 --output - | tar xpf - -C /mnt/root
```

### Windows Provisioning
- Partition creation with MSR (Microsoft Reserved) support
- NTFS filesystem creation via `ntfs-3g` and `mkfs.ntfs`
- WIM image application via `wimapply` (wimlib-utils) from embedded registry
- Windows boot file setup and UEFI configuration
- Unattend.xml placement for automated setup

**OCI Registry Integration:**
The maintenance OS pulls WIM images from the Shoal embedded registry:
```bash
oras pull controller:8080/os-images/windows-server:2022 --output - > install.wim
wimapply install.wim 1 /mnt/windows
```

**Required packages for Windows workflows:**
- `wimlib-utils` – WIM image extraction and application (LGPLv3+)
- `ntfs-3g` – NTFS filesystem mounting and creation (GPL-2.0+)

## Outputs

The ISO directory contains:

- `install.iso` – bootable maintenance OS image ready for virtual media.
- Build metadata and logs generated by `bootc-image-builder` describing the compose.

These artifacts should be published at a stable URL for the controller to mount during provisioning.
