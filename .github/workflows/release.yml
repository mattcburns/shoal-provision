name: Release

on:
  # Automatic release creation when tags are pushed
  push:
    tags:
      - 'v*'

  # Allow manual release creation for testing
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0-beta)'
        required: true
        default: 'v0.0.1-test'
      prerelease:
        description: 'Mark as pre-release'
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  validate-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for proper release notes

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'  # Updated to match project requirements
          cache: true

      - name: Install build tools
        run: |
          echo "üì¶ Installing build and security tools..."
          go run build.go install-tools

          # Install SBOM generation tool
          go install github.com/anchore/syft/cmd/syft@latest

          # Install signing tool (cosign)
          go install github.com/sigstore/cosign/v2/cmd/cosign@latest

      - name: Validate code quality
        run: |
          echo "üîç Running full validation pipeline..."
          go run build.go validate

      - name: Build all platform binaries
        id: build
        run: |
          echo "üèóÔ∏è Building binaries for all supported platforms..."
          go run build.go build-all

          # Also build dispatcher binaries
          echo "üèóÔ∏è Building dispatcher binaries..."
          cd cmd/provisioner-dispatcher

          # Linux amd64
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o ../../build/dispatcher-linux-amd64 .

          # Linux arm64
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o ../../build/dispatcher-linux-arm64 .

          cd ../..

          echo "artifact_path=build" >> $GITHUB_OUTPUT

          echo "‚úÖ All binaries built"
          ls -lh build/

      - name: Generate SBOMs
        run: |
          echo "üìã Generating Software Bill of Materials (SBOMs)..."

          # Generate SBOM for the Go project
          $HOME/go/bin/syft . -o spdx-json=build/shoal-sbom.spdx.json
          $HOME/go/bin/syft . -o cyclonedx-json=build/shoal-sbom.cyclonedx.json

          # Generate text summary for easy viewing
          $HOME/go/bin/syft . -o table=build/shoal-sbom.txt

          echo "‚úÖ SBOMs generated"
          ls -lh build/*.json build/*.txt

      - name: Generate checksums
        run: |
          cd build
          echo "üìã Generating SHA256 checksums..."
          sha256sum shoal-* dispatcher-* *.json *.txt > SHA256SUMS 2>/dev/null || sha256sum shoal-* dispatcher-* > SHA256SUMS
          echo "Generated checksums:"
          cat SHA256SUMS

      - name: Sign artifacts
        if: github.event_name == 'push'  # Only sign on actual tag pushes, not manual dispatch
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          echo "üîê Signing release artifacts..."

          cd build

          # Sign checksums file with cosign (keyless signing using OIDC)
          $HOME/go/bin/cosign sign-blob \
            --yes \
            --output-signature SHA256SUMS.sig \
            --output-certificate SHA256SUMS.pem \
            SHA256SUMS

          echo "‚úÖ Artifacts signed"
          ls -lh *.sig *.pem

      - name: Determine release type
        id: release-type
        run: |
          VERSION="${{ github.event.inputs.version || github.ref_name }}"

          # Determine if this should be a prerelease
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Manual dispatch - use the checkbox input
            PRERELEASE="${{ github.event.inputs.prerelease }}"
          elif [[ "$VERSION" =~ -(alpha|beta|rc|test|dev) ]]; then
            # Tag contains pre-release identifiers
            PRERELEASE="true"
          else
            # Regular release tag
            PRERELEASE="false"
          fi

          echo "prerelease=$PRERELEASE" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"
          echo "Pre-release: $PRERELEASE"

      - name: Generate release notes
        id: release-notes
        run: |
          VERSION="${{ steps.release-type.outputs.version }}"

          # Create release notes
          cat << EOF > release_notes.md
          ## Shoal $VERSION

          ### üì¶ Pre-built Binaries

          This release includes pre-built binaries for multiple platforms:

          | Platform | Architecture | Binary |
          |----------|--------------|--------|
          | Linux | x86_64 | \`shoal-linux-amd64\` |
          | Linux | ARM64 | \`shoal-linux-arm64\` |
          | macOS | x86_64 | \`shoal-darwin-amd64\` |
          | macOS | ARM64 | \`shoal-darwin-arm64\` |
          | Windows | x86_64 | \`shoal-windows-amd64.exe\` |

          ### ÔøΩ Dispatcher Binaries

          Static binaries for the provisioner dispatcher (used inside maintenance OS):

          | Platform | Architecture | Binary |
          |----------|--------------|--------|
          | Linux | x86_64 | \`dispatcher-linux-amd64\` |
          | Linux | ARM64 | \`dispatcher-linux-arm64\` |

          ### üìã Software Bill of Materials (SBOM)

          This release includes SBOMs in multiple formats:
          - **SPDX JSON**: \`shoal-sbom.spdx.json\`
          - **CycloneDX JSON**: \`shoal-sbom.cyclonedx.json\`
          - **Text summary**: \`shoal-sbom.txt\`

          ###  Security

          - **SHA256 Checksums**: All binaries include SHA256 checksums in \`SHA256SUMS\`
          - **Digital Signatures**: Checksums are signed with cosign (keyless OIDC) - see \`SHA256SUMS.sig\` and \`SHA256SUMS.pem\`
          - **Verify downloads**: \`sha256sum -c SHA256SUMS\` (Linux/macOS) or check manually
          - **Verify signature**: \`cosign verify-blob --certificate SHA256SUMS.pem --signature SHA256SUMS.sig SHA256SUMS\`

          ### üöÄ Installation

          1. Download the appropriate binary for your platform
          2. Verify the checksum (recommended)
          3. Make executable: \`chmod +x shoal-*\` (Linux/macOS)
          4. Run: \`./shoal-linux-amd64 -port 8080\`

          ### üìñ Documentation

          For usage instructions, configuration options, and API documentation, see the [README.md](https://github.com/mattcburns/shoal/blob/master/README.md).

          ---

          **Built from**: \`${{ github.sha }}\`
          **Build Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          EOF

          echo "Generated release notes:"
          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release-type.outputs.version }}
          name: ${{ steps.release-type.outputs.version }}
          body_path: release_notes.md
          prerelease: ${{ steps.release-type.outputs.prerelease }}
          files: |
            build/shoal-*
            build/dispatcher-*
            build/SHA256SUMS
            build/SHA256SUMS.sig
            build/SHA256SUMS.pem
            build/*.spdx.json
            build/*.cyclonedx.json
            build/*.txt
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "‚úÖ Release created successfully!"
          echo "üì¶ Version: ${{ steps.release-type.outputs.version }}"
          echo "üè∑Ô∏è Pre-release: ${{ steps.release-type.outputs.prerelease }}"
          echo "üîó View at: https://github.com/${{ github.repository }}/releases/tag/${{ steps.release-type.outputs.version }}"
